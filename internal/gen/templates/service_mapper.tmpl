// File generated by lazyent. DO NOT EDIT.
package service

import (
	"errors"

	"{{ .BizPackage }}"
	pb "{{ .ApiPackage }}"
{{- if hasTimeNodes .Nodes }}
	"google.golang.org/protobuf/types/known/timestamppb"
{{- end }}
{{- if hasUUIDNodes .Nodes }}
	"github.com/google/uuid"
{{- end }}
)

{{- range .Nodes }}
{{- $node := . }}
func Biz{{ .Name }}ToProto(b *biz.{{ .Name }}) (*pb.{{ .Name }}, error) {
	if b == nil {
		return nil, errors.New("Biz{{ .Name }}ToProto: nil entity")
	}
{{- range $e := .Edges }}
{{- if isProtoExclude $e }}{{ continue }}{{ end }}
{{- if isProtoMessage $e }}
	{{- if $e.Unique }}
	{{ camel $e.Name }}, err := Biz{{ $e.Type.Name }}ToProto(b.{{ bizEdgeName $e }})
	if err != nil {
		return nil, err
	}
	{{- else }}
	var {{ camel $e.Name }} []*pb.{{ $e.Type.Name }}
	for _, item := range b.{{ bizEdgeName $e }} {
		v, err := Biz{{ $e.Type.Name }}ToProto(item)
		if err != nil {
			return nil, err
		}
		{{ camel $e.Name }} = append({{ camel $e.Name }}, v)
	}
	{{- end }}
{{- else }}
    {{/* ID List Handling */}}
    {{- if not $e.Unique }}
    var {{ camel (protoStructField $e) }} []{{ edgeProtoType $e }}
    for _, item := range b.{{ bizEdgeName $e }} {
        {{ camel (protoStructField $e) }} = append({{ camel (protoStructField $e) }}, item)
    }
    {{- end }}
{{- end }}
{{- end }}
	return &pb.{{ .Name }}{
{{- range $f := .Fields }}
		{{ $f.StructField }}: {{ convertToProto $f $node.Name }},
{{- end }}
{{- range $e := .Edges }}
{{- if isProtoExclude $e }}{{ continue }}{{ end }}
{{- if isProtoMessage $e }}
	{{- if $e.Unique }}
		{{ $e.Name | pascal }}: {{ camel $e.Name }},
	{{- else }}
		{{ $e.Name | pascal }}: {{ camel $e.Name }},
	{{- end }}
{{- else }}
	{{/* ProtoID */}}
    {{- if not $e.Unique }}
        {{ protoStructField $e }}: {{ camel (protoStructField $e) }},
    {{- else }}
        {{- if and (edgeHasFK $e) (not (hasField $node.Fields (edgeField $e))) }}
            {{ protoStructField $e }}: {{ edgeConvertToProto $e }},
        {{- end }}
    {{- end }}
{{- end }}
{{- end }}
	}, nil
}

func Proto{{ .Name }}ToBiz(p *pb.{{ .Name }}) (*biz.{{ .Name }}, error) {
	if p == nil {
		return nil, errors.New("Proto{{ .Name }}ToBiz: nil entity")
	}
{{- range $e := .Edges }}
{{- if isBizExclude $e }}{{ continue }}{{ end }}
{{- if isBizPointer $e }}
	{{- if $e.Unique }}
	{{ camel (bizEdgeName $e) }}, err := Proto{{ $e.Type.Name }}ToBiz(p.{{ protoStructField $e }})
	if err != nil {
		return nil, err
	}
	{{- else }}
	var {{ camel (bizEdgeName $e) }} []*biz.{{ $e.Type.Name }}
	for _, item := range p.{{ protoStructField $e }} {
		v, err := Proto{{ $e.Type.Name }}ToBiz(item)
		if err != nil {
			return nil, err
		}
		{{ camel (bizEdgeName $e) }} = append({{ camel (bizEdgeName $e) }}, v)
	}
	{{- end }}
{{- else }}
    {{/* ID List Handling for BizIDOnly */}}
    {{- if and (isBizIDOnly $e) (not $e.Unique) }}
	{{ $idType := edgeIDType $e }}{{ if eq $idType "uuid.UUID" }}{{ $idType = "string" }}{{ end }}
    var {{ camel (bizEdgeName $e) }} []{{ $idType }}
    for _, item := range p.{{ protoStructField $e }} {
        {{ camel (bizEdgeName $e) }} = append({{ camel (bizEdgeName $e) }}, item)
    }
    {{- end }}
{{- end }}
{{- end }}
	return &biz.{{ .Name }}{
		{{ .Name }}Base: biz.{{ .Name }}Base{
{{- range $f := .Fields }}
			{{ bizFieldName $f }}: {{ convertFromProto $f $node.Name }},
{{- end }}
{{- range $e := .Edges }}
{{- if isBizExclude $e }}{{ continue }}{{ end }}
{{/* ID Field */}}
{{- if and (edgeHasFK $e) (not (hasField $node.Fields (edgeField $e))) }}
			{{ edgeField $e }}: {{ edgeConvertFromProto $e }}, 
{{- end }}
{{/* Relationship Field */}}
{{- if isBizIDOnly $e }}{{/* No field */}}{{ else }}
	{{- if isBizPointer $e }}
		{{- if $e.Unique }}
			{{ bizEdgeName $e }}: {{ camel (bizEdgeName $e) }},
		{{- else }}
			{{ bizEdgeName $e }}: {{ camel (bizEdgeName $e) }},
		{{- end }}
	{{- end }}

{{- end }}
{{- if and (isBizIDOnly $e) (not $e.Unique) }}
    {{ bizEdgeName $e }}: {{ camel (bizEdgeName $e) }},
{{- end }}
{{- end }}
		},
	}, nil
}
{{- end }}

{{/* Enum Mappers */}}
{{- range $enum := getAllEnums .Nodes }}
func {{ enumToProtoFunc $enum.Field $enum.NodeName }}(e biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }}) pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }} {
	switch e {
	{{- range $pair := getEnumPairs $enum.Field }}
	case biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }}{{ $pair.Key | pascal }}:
		return pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}_{{ $enum.NodeName | upper }}{{ $enum.Field.StructField | upper }}_{{ $pair.Key }}
	{{- end }}
	default:
		return pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}_{{ $enum.NodeName | upper }}{{ $enum.Field.StructField | upper }}_UNSPECIFIED
	}
}

func {{ enumFromProtoFunc $enum.Field $enum.NodeName }}(e pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}) biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }} {
	switch e {
	{{- range $pair := getEnumPairs $enum.Field }}
	case pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}_{{ $enum.NodeName | upper }}{{ $enum.Field.StructField | upper }}_{{ $pair.Key }}:
		return biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }}{{ $pair.Key | pascal }}
	{{- end }}
	default:
		{{- $default := printf "biz.%s%s(0)" $enum.NodeName $enum.Field.StructField }}
		{{- range $pair := getEnumPairs $enum.Field }}
			{{- if eq $pair.Value 0 }}
				{{- $default = printf "biz.%s%s%s" $enum.NodeName $enum.Field.StructField ($pair.Key | pascal) }}
			{{- end }}
		{{- end }}
		return {{ $default }}
	}
}
{{- end }}
