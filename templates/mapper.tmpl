package service

import (
	"{{ .BizPackage }}"
	pb "{{ .ApiPackage }}"
{{- if hasTimeNodes .Nodes }}
	"google.golang.org/protobuf/types/known/timestamppb"
{{- end }}
{{- if hasUUIDNodes .Nodes }}
	"github.com/google/uuid"
{{- end }}
)

{{- range .Nodes }}
{{- $node := . }}
// ToProto 将 Biz 实体转换为 Proto Message
func ToProto{{ .Name }}(b *biz.{{ .Name }}) *pb.{{ .Name }} {
	if b == nil {
		return nil
	}
	return &pb.{{ .Name }}{
{{- range $f := .Fields }}
		{{ $f.StructField }}: {{ convertToProto $f $node.Name }},
{{- end }}
{{- range $e := .Edges }}
{{- if isProtoExclude $e }}{{ continue }}{{ end }}
{{- if isProtoMessage $e }}
	{{- if $e.Unique }}
		{{ $e.Name }}: {{ edgeConvertToProto $e }},
	{{- else }}
		// Repeated field: {{ $e.Name }} (TODO: Handle List conversion)
	{{- end }}
{{- else }}
	{{/* ProtoID */}}
	{{- if and (edgeHasFK $e) (not (hasField $node.Fields (edgeField $e))) }}
		{{ $e.Name }}_id: {{ edgeConvertToProto $e }},
	{{- end }}
{{- end }}
{{- end }}
	}
}

// FromProto 将 Proto Message 转换为 Biz 实体
func FromProto{{ .Name }}(p *pb.{{ .Name }}) *biz.{{ .Name }} {
	if p == nil {
		return nil
	}
	return &biz.{{ .Name }}{
		{{ .Name }}Base: biz.{{ .Name }}Base{
{{- range $f := .Fields }}
			{{ $f.StructField }}: {{ convertFromProto $f $node.Name }},
{{- end }}
{{- range $e := .Edges }}
{{- if isBizExclude $e }}{{ continue }}{{ end }}
{{/* ID Field */}}
{{- if and (edgeHasFK $e) (not (hasField $node.Fields (edgeField $e))) }}
			{{ edgeField $e }}: {{ edgeConvertFromProto $e }}, // Maps ID from ProtoID or ignores if mismatch
{{- end }}
{{/* Relationship Field */}}
{{- if isBizIDOnly $e }}{{/* No field */}}{{ else }}
	{{- if isBizPointer $e }}
			{{ $e.StructField }}: {{ edgeConvertFromProto $e }},
	{{- end }}
	{{- if isBizValue $e }}
			{{ $e.StructField }}: {{ edgeConvertFromProto $e }},
	{{- end }}
{{- end }}
{{- end }}
		},
	}
}
{{- end }}

{{/* Enum Mappers */}}
{{- range $enum := getAllEnums .Nodes }}
// {{ enumToProtoFunc $enum.Field $enum.NodeName }} Enum Mapping
func {{ enumToProtoFunc $enum.Field $enum.NodeName }}(e biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }}) pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }} {
	switch e {
	{{- range $k, $v := getEnumValues $enum.Field }}
	case biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }}{{ $k }}:
		return pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}_{{ $k }}
	{{- end }}
	default:
		return pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}_{{ $enum.NodeName }}{{ $enum.Field.StructField }}_UNSPECIFIED
	}
}

// {{ enumFromProtoFunc $enum.Field $enum.NodeName }} Enum Mapping
func {{ enumFromProtoFunc $enum.Field $enum.NodeName }}(e pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}) biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }} {
	switch e {
	{{- range $k, $v := getEnumValues $enum.Field }}
	case pb.{{ $enum.NodeName }}{{ $enum.Field.StructField }}_{{ $k }}:
		return biz.{{ $enum.NodeName }}{{ $enum.Field.StructField }}{{ $k }}
	{{- end }}
	default:
		{{- $default := printf "biz.%s%s(0)" $enum.NodeName $enum.Field.StructField }}
		{{- range $k, $v := getEnumValues $enum.Field }}
			{{- if eq $v 0 }}
				{{- $default = printf "biz.%s%s%s" $enum.NodeName $enum.Field.StructField $k }}
			{{- end }}
		{{- end }}
		return {{ $default }}
	}
}
{{- end }}
